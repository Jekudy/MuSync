# üîí MuSync Security Guide

## –û–±–∑–æ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

MuSync —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø—É –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤. –í—Å–µ —Ç–æ–∫–µ–Ω—ã –∏ –∫–ª—é—á–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∫–æ–¥–∞.

## üéØ Spotify Scopes

### –¢—Ä–µ–±—É–µ–º—ã–µ scopes

–ë–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä (–ø–ª–µ–π–ª–∏—Å—Ç—ã):

- `playlist-read-private` - —á—Ç–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `playlist-modify-public` - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤
- `playlist-modify-private` - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤

### –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ scopes

| Scope | –ó–∞—á–µ–º –Ω—É–∂–µ–Ω | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã |
|-------|-------------|--------------|
| `playlist-read-private` | –ß—Ç–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ | –ù–µ—Ç - –±–µ–∑ —ç—Ç–æ–≥–æ –Ω–µ –º–æ–∂–µ–º —á–∏—Ç–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã |
| `playlist-modify-public` | –°–æ–∑–¥–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ –≤ Spotify | –ú–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ç–æ–ª—å–∫–æ `playlist-modify-private` |
| `playlist-modify-private` | –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ –≤ Spotify | –ú–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ç–æ–ª—å–∫–æ `playlist-modify-public` |

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ scopes –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ª–∞–π–∫–æ–≤:

- `user-library-read` - —á—Ç–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏/–ª–∞–π–∫–æ–≤
- `user-library-modify` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ "–ü–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è —Ç—Ä–µ–∫–∏"

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —ç—Ç–∏ –ø—Ä–∞–≤–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –ª–∞–π–∫–∏ –≤ Liked Songs.

## üîê –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
~/.musync/
‚îú‚îÄ‚îÄ .env                    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (client secrets)
‚îî‚îÄ‚îÄ tokens.json            # OAuth —Ç–æ–∫–µ–Ω—ã (access/refresh tokens)
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```bash
# Spotify OAuth App credentials
SPOTIFY_CLIENT_ID=your_client_id_here
SPOTIFY_CLIENT_SECRET=your_client_secret_here
SPOTIFY_REDIRECT_URI=http://localhost:3000/callback

# Yandex Music token (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ tokens.json)
YANDEX_TOKEN=your_yandex_token_here
```

### OAuth —Ç–æ–∫–µ–Ω—ã (tokens.json)

```json
{
  "spotify": {
    "access_token": "BQABC123...",
    "refresh_token": "AQABC123..."
  },
  "yandex": {
    "access_token": "y0_AgAAAAA..."
  }
}
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤

### .gitignore

–°–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã –ù–ï –∫–æ–º–º–∏—Ç—è—Ç—Å—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

```
# Secrets
.env
tokens.json
*.token
*.secret

# Config directories
~/.musync/
.musync/

# Logs (–º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã)
*.log
logs/

# Temporary files
*.tmp
*.temp
```

### –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —Ñ–∞–π–ª–æ–≤ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏:

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
mkdir -p ~/.musync
chmod 700 ~/.musync

# –§–∞–π–ª—ã —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
chmod 600 ~/.musync/.env
chmod 600 ~/.musync/tokens.json
```

## üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ scopes

```python
from app.crosscutting.config import get_secret_manager

manager = get_secret_manager()

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ scopes
scopes = "playlist-read-private playlist-modify-public playlist-modify-private"
is_valid = manager.validate_spotify_scopes(scopes)

# –ü–æ–ª—É—á–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ scopes
missing = manager.get_missing_spotify_scopes("playlist-read-private")
# –í–µ—Ä–Ω—ë—Ç: ['playlist-modify-public', 'playlist-modify-private']
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```python
# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
summary = manager.get_config_summary()
print(summary)

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
    'config_dir': '/home/user/.musync',
    'tokens_file': '/home/user/.musync/tokens.json',
    'env_file': '/home/user/.musync/.env',
    'validation': {
        'spotify_client_id': True,
        'spotify_client_secret': True,
        'spotify_redirect_uri': True,
        'yandex_token': True,
        'spotify_tokens': True
    },
    'spotify_scopes': ['playlist-read-private', 'playlist-modify-public', 'playlist-modify-private'],
    'has_spotify_tokens': True,
    'has_yandex_token': True
}
```

## üö® –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 1. –†–µ–≥—É–ª—è—Ä–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤

- Spotify access tokens –∏—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 1 —á–∞—Å
- Refresh tokens –º–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å –≤ Spotify Dashboard
- Yandex tokens –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∞–∫–∫–∞—É–Ω—Ç–∞

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–∞

- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –≤ Spotify
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤)

### 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º

- –•—Ä–∞–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã —Ç–æ–ª—å–∫–æ –Ω–∞ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö
- –ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —Ñ–∞–π–ª—ã —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –ø–æ –Ω–µ–∑–∞—â–∏—â—ë–Ω–Ω—ã–º –∫–∞–Ω–∞–ª–∞–º
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã

### 4. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ git
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .env.example –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å mock-–¥–∞–Ω–Ω—ã–º–∏, –Ω–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Spotify OAuth App

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [Spotify Developer Dashboard](https://developer.spotify.com/dashboard)
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ó–∞–ø–∏—à–∏—Ç–µ Client ID –∏ Client Secret

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redirect URI

–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ:
```
http://localhost:3000/callback
```

### 3. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ scopes

–í—ã–±–∏—Ä–∞–π—Ç–µ –Ω–∞–±–æ—Ä –ø–æ–¥ –∑–∞–¥–∞—á—É:

- –¢–æ–ª—å–∫–æ –ø–ª–µ–π–ª–∏—Å—Ç—ã:
```
playlist-read-private playlist-modify-public playlist-modify-private
```

- –ü–ª–µ–π–ª–∏—Å—Ç—ã + –ª–∞–π–∫–∏:
```
user-library-read user-library-modify playlist-read-private playlist-modify-public playlist-modify-private
```

## üß™ Smoke-—Ç–µ—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ scopes:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å smoke-—Ç–µ—Å—Ç
python3 -m pytest app/tests/crosscutting/test_config.py::TestSecuritySmoke::test_minimal_scopes_work
```

–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
- ‚úÖ –†–∞–±–æ—Ç—É —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ scopes
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
