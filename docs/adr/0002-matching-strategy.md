# ADR 0002: Стратегия матчинга треков (актуализировано)

## Контекст
Необходимо обеспечить высокий матч‑рейт при минимуме ложных совпадений и с объяснимостью результата.

## Решение
- Поиск: два запроса по умолчанию — `track:"{title}" artist:"{primaryArtist}"` → при отсутствии «очевидного» совпадения — свободный `"{title} {artist}"`; title‑only и транслит — по флагам.
- Выбор (без ambiguous‑стопа):
  - full‑text match: нормализованный title равен, artist‑overlap ≥1 (игнорируем хвостовые токены типа «№7», `live`, `remaster`).
  - если таких >1: tie‑break по совпадению альбома (если известен у источника) → затем по позиции в выдаче Spotify (rank).
  - при отсутствии full‑text — допускается ослабленный artist‑overlap; те же тай‑брейки.
- Duration не используется как гейт; может быть включён как tie‑breaker по флагу.
- Нормализация: регистр, диакритика, feat/ft., `&/и`, скобочные хвосты; для артистов — игнор хвостов.
- Логи диагностики по флагу: запросы, top‑k кандидатов, нормализованные поля, выбранные тай‑брейкеры.

## Последствия
- Рост recall за счёт отказа от ambiguous‑стопов; управляемые предохранители и тай‑брейки снижают риск false‑match.
- Простая деградация поиска, минимум round‑trips.
- Чёткие метрики и диагностические отчёты для калибровки.


