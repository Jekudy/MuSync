# TEST PLAN — MuSync (Итерации 1–3)

## 1. Стратегия тестирования
- Пирамидальная: юнит → контрактные → интеграционные → e2e (acceptance).
- Test gating: релиз разрешён только при выполнении порогов PRD v3.
- Все тест‑руннеры и CLI задачи завершаются корректным exit‑кодом; таймаут по умолчанию на короткие задачи ≤ 60 сек, без зависаний.

## 2. Юнит‑тесты (Итер.1 — минимум)
- Идемпотентность: расчёт snapshotHash; отсутствие дублей при повторном запуске.
- Матчинг: нормализация, exact по title/artist/duration±2с, fuzzy пороги и объяснимость.
- Батчинг и чекпойнты: корректная сегментация по N, восстановление из checkpoint.
- Backoff и дедлайны: корректное ограничение попыток, уважение retry‑after (см. контракты).

## 3. Контрактные тесты портов
### 3.1 MusicProvider (Spotify, Яндекс)
- readPlaylists(): возвращает только собственные плейлисты (для источника) и корректные метаданные (для цели).
- searchTrack(): поддерживает ISRC и полнотекстовый поиск; детерминированные поля для сравнения.
- addTracks(): добавление батчами, без дублей на повторных вызовах при неизменном snapshot.
### 3.2 Secrets/Metrics/Storage
- Secrets: доступ по ключу, отсутствие утечек в логах.
- Storage: сохранение/чтение чекпойнтов и отчётов; долговечность.
- Metrics: счётчики и таймеры по именам из архитектуры.

## 4. Интеграционные тесты
- Dry‑run пайплайна без записи; полный отчёт и метрики.
- Обработка 429/5xx провайдера с backoff и восстановлением.

## 5. E2E / Acceptance (Итер.1)
- Набор тест‑плейлистов и треков (acceptance CSV). Сценарии:
  - Перенос собственного плейлиста Яндекс → Spotify, match ≥ 90%.
  - Повторный запуск с тем же снапшотом: 0 дублей, отчёт обновлён.
  - Большой плейлист (10k): TTS ≤ 5 мин при соблюдении RL.
- Отчётность: JSON‑отчёт со сводкой totals/percentiles/errors, причины not_found.

## 6. Пороговые значения (gating)
- Match rate ≥ 90%, false match ≤ 2%.
- Coverage критичных модулей ≥ 80%.
- Все контракты адаптеров — зелёные.
- Нет зависаний > 1 мин; корректные exit‑коды.

## 7. Итерации 2–3 (добавки)
- Provider plug‑in тесты: добавление нового провайдера без изменения домена.
- Дельта‑синк: повторный запуск < 60 сек на 10k треков.
- Очереди и воркеры: изоляция tenant‑ов, квоты/дросселирование, circuit breaker.

## 8. Репортинг
- Публикация JSON‑отчёта и экспорт метрик для наблюдаемости.
- Сохранение артефактов отчётов для отладки/аудита.


